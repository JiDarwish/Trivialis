version: '3.8'

services:
  nginx:
    image: nginx:1.19.6-alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx:/etc/nginx/conf.d
      - ./certbot-etc:/etc/letsencrypt
      - ./certbot-var:/var/lib/letsencrypt
    depends_on:
      - webapp

  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./certbot-etc:/etc/letsencrypt
      - ./certbot-var:/var/lib/letsencrypt

  webapp:
    build:
      context: ./webapp
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - NEXT_PUBLIC_CLIENTVAR=${NEXT_PUBLIC_CLIENTVAR}
    depends_on:
      - langchain

  langchain:
    build: ./langchain
    command:
      [
        "uvicorn",
        "main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000"
      ]
    volumes:
      - ./langchain:/app
    ports:
      - 8000:8000
    depends_on:
      - db
      - cache

  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

  cache:
    image: redis:6.2
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
